<html>

							<head>

								<title>Delphi Code Slice: start line: 6348 vars: ["\'1\'","dbhandle","historyrec","3"] </title>

							</head>

							<body>

							<p><b>Delphi Code Slice: start line: 6348 vars: ["\'1\'","dbhandle","historyrec","3"]</b><br></p>
							<table width="100%">

							<tr id="SliceElement_0"><th>&nbsp;</th><th ><a href="#SliceElement_1">Next</a></th><th>&nbsp;</th></tr>
	<tr><th>&nbsp;</th><td>&nbsp;</td><td><font size="3" color="grey">&nbsp;<hr></font><br></td></tr>
	<tr id="SliceElement_1"><th>1202:</th><td><a href="#SliceElement_0">Prev</a> - <a href="#SliceElement_2">Next</a></td>
																						   <td><b><font color='orange'>function stoi(p : string; len, offs : integer) : integer;</font></b><br></td></tr>
	<tr><th>1203:</th><td>&nbsp;</td><td><font size="3" color="grey">var</font><br></td></tr>
	<tr><th>1204:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;i : integer;</font><br></td></tr>
	<tr><th>1205:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;answer, compare : integer;</font><br></td></tr>
	<tr><th>1206:</th><td>&nbsp;</td><td><font size="3" color="grey">begin</font><br></td></tr>
	<tr id="SliceElement_2"><th>1207:</th><td><a href="#SliceElement_1">Prev</a> - <a href="#SliceElement_3">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;if (len &gt; 5) then len := 5;</font></b><br></td></tr>
	<tr id="SliceElement_3"><th>1208:</th><td><a href="#SliceElement_2">Prev</a> - <a href="#SliceElement_4">Next</a></td>
																						   <td><b><font color='red'> &nbsp;if ((offs + len) &gt; length(p)) then</font></b><br></td></tr>
	<tr><th>1209:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;begin</font><br></td></tr>
	<tr id="SliceElement_4"><th>1210:</th><td><a href="#SliceElement_3">Prev</a> - <a href="#SliceElement_5">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;result := maxint;</font></b><br></td></tr>
	<tr><th>1211:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>1212:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr><th>1213:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_5"><th>1214:</th><td><a href="#SliceElement_4">Prev</a> - <a href="#SliceElement_6">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;answer &nbsp;:= 0;</font></b><br></td></tr>
	<tr id="SliceElement_6"><th>1215:</th><td><a href="#SliceElement_5">Prev</a> - <a href="#SliceElement_7">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;compare := 0;</font></b><br></td></tr>
	<tr><th>1216:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_7"><th>1217:</th><td><a href="#SliceElement_6">Prev</a> - <a href="#SliceElement_8">Next</a></td>
																						   <td><b><font color='red'> &nbsp;for i := 1 to len do</font></b><br></td></tr>
	<tr><th>1218:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;begin</font><br></td></tr>
	<tr id="SliceElement_8"><th>1219:</th><td><a href="#SliceElement_7">Prev</a> - <a href="#SliceElement_9">Next</a></td>
																						   <td><b><font color='red'> &nbsp; &nbsp;if (p[i+offs] &lt; '0') then</font></b><br></td></tr>
	<tr><th>1220:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;begin</font><br></td></tr>
	<tr id="SliceElement_9"><th>1221:</th><td><a href="#SliceElement_8">Prev</a> - <a href="#SliceElement_10">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp; &nbsp;result := maxint;</font></b><br></td></tr>
	<tr><th>1222:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>1223:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end;</font><br></td></tr>
	<tr id="SliceElement_10"><th>1224:</th><td><a href="#SliceElement_9">Prev</a> - <a href="#SliceElement_11">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;answer &nbsp;:= answer * 208 + ord(p[i+offs]) - ord('0');</font></b><br></td></tr>
	<tr id="SliceElement_11"><th>1225:</th><td><a href="#SliceElement_10">Prev</a> - <a href="#SliceElement_12">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;compare := compare * 208;</font></b><br></td></tr>
	<tr><th>1226:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr><th>1227:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_12"><th>1228:</th><td><a href="#SliceElement_11">Prev</a> - <a href="#SliceElement_13">Next</a></td>
																						   <td><b><font color='red'> &nbsp;if ( (answer &lt; compare div 2) or (len=5) ) then</font></b><br></td></tr>
	<tr id="SliceElement_13"><th>1229:</th><td><a href="#SliceElement_12">Prev</a> - <a href="#SliceElement_14">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;result := answer</font></b><br></td></tr>
	<tr><th>1230:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;else</font><br></td></tr>
	<tr id="SliceElement_14"><th>1231:</th><td><a href="#SliceElement_13">Prev</a> - <a href="#SliceElement_15">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;result := answer - compare;</font></b><br></td></tr>
	<tr><th>1232:</th><td>&nbsp;</td><td><font size="3" color="grey">end;</font><br></td></tr>
	<tr><th>&nbsp;</th><td>&nbsp;</td><td><font size="3" color="grey">&nbsp;<hr></font><br></td></tr>
	<tr id="SliceElement_15"><th>4995:</th><td><a href="#SliceElement_14">Prev</a> - <a href="#SliceElement_16">Next</a></td>
																						   <td><b><font color='orange'>procedure tquirtpatient.getpatienthistory (value : string; var rec, prec: int64);</font></b><br></td></tr>
	<tr><th>4996:</th><td>&nbsp;</td><td><font size="3" color="grey">const</font><br></td></tr>
	<tr><th>4997:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;maxlinks &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 2000;</font><br></td></tr>
	<tr><th>4998:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>4999:</th><td>&nbsp;</td><td><font size="3" color="grey">var</font><br></td></tr>
	<tr><th>5000:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;i, hdb, hcount, cnt, d &nbsp; &nbsp; : integer;</font><br></td></tr>
	<tr><th>5001:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;tmp1, tmp2, tmp3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : string;</font><br></td></tr>
	<tr><th>5002:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5003:</th><td>&nbsp;</td><td><font size="3" color="grey">begin</font><br></td></tr>
	<tr><th>5004:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;prec &nbsp; &nbsp; &nbsp; &nbsp; := -1;</font><br></td></tr>
	<tr><th>5005:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;farchiveflag := -1;</font><br></td></tr>
	<tr><th>5006:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5007:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;{ test existence database }</font><br></td></tr>
	<tr><th>5008:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;if not fileexists(fqe.fhistorydbname) then exit;</font><br></td></tr>
	<tr><th>5009:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5010:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;{ compute the hash function on the patient id }</font><br></td></tr>
	<tr><th>5011:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_16"><th>5012:</th><td><a href="#SliceElement_15">Prev</a> - <a href="#SliceElement_17">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;rec &nbsp; := 0;</font></b><br></td></tr>
	<tr id="SliceElement_17"><th>5013:</th><td><a href="#SliceElement_16">Prev</a> - <a href="#SliceElement_18">Next</a></td>
																						   <td><b><font color='red'> &nbsp;for i := 1 to length(value) do</font></b><br></td></tr>
	<tr><th>5014:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;begin</font><br></td></tr>
	<tr id="SliceElement_18"><th>5015:</th><td><a href="#SliceElement_17">Prev</a> - <a href="#SliceElement_19">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;rec := rec * 10;</font></b><br></td></tr>
	<tr id="SliceElement_19"><th>5016:</th><td><a href="#SliceElement_18">Prev</a> - <a href="#SliceElement_20">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;rec := rec + ord(value[i]);</font></b><br></td></tr>
	<tr><th>5017:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr id="SliceElement_20"><th>5018:</th><td><a href="#SliceElement_19">Prev</a> - <a href="#SliceElement_21">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;rec := abs(rec);</font></b><br></td></tr>
	<tr><th>5019:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5020:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;{ read the number of hash values from record 0 in the database }</font><br></td></tr>
	<tr><th>5021:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5022:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;dbf_open(hdb, fqe.fhistorydbname, true);</font><br></td></tr>
	<tr><th>5023:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;dbf_read_field(tmp2, hdb, 0, 2);</font><br></td></tr>
	<tr id="SliceElement_21"><th>5024:</th><td><a href="#SliceElement_20">Prev</a> - <a href="#SliceElement_22">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;hcount := stoi(tmp2, 3, 0);</font></b><br></td></tr>
	<tr id="SliceElement_22"><th>5025:</th><td><a href="#SliceElement_21">Prev</a> - <a href="#SliceElement_23">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;rec &nbsp; &nbsp;:= (rec mod hcount) + 1;</font></b><br></td></tr>
	<tr><th>5026:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_23"><th>5027:</th><td><a href="#SliceElement_22">Prev</a> - <a href="#SliceElement_24">Next</a></td>
																						   <td><b><font color='red'> &nbsp;if (hcount = maxint) then</font></b><br></td></tr>
	<tr><th>5028:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;begin</font><br></td></tr>
	<tr id="SliceElement_24"><th>5029:</th><td><a href="#SliceElement_23">Prev</a> - <a href="#SliceElement_25">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;rec := -1;</font></b><br></td></tr>
	<tr><th>5030:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;ferrors.add('error reading hash count from history database.', 0, 0, false, true);</font><br></td></tr>
	<tr><th>5031:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;dbf_close(hdb);</font><br></td></tr>
	<tr><th>5032:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>5033:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr><th>5034:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5035:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;{ search the linked list }</font><br></td></tr>
	<tr><th>5036:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_25"><th>5037:</th><td><a href="#SliceElement_24">Prev</a> - <a href="#SliceElement_26">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;cnt := 0;</font></b><br></td></tr>
	<tr><th>5038:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_26"><th>5039:</th><td><a href="#SliceElement_25">Prev</a> - <a href="#SliceElement_27">Next</a></td>
																						   <td><b><font color='red'> &nbsp;while (rec &lt;&gt; 0) and (cnt &lt; maxlinks) do</font></b><br></td></tr>
	<tr><th>5040:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;begin</font><br></td></tr>
	<tr><th>5041:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;prec := rec;</font><br></td></tr>
	<tr><th>5042:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;dbf_read_field(tmp1, hdb, rec, 1);</font><br></td></tr>
	<tr><th>5043:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;dbf_read_field(tmp2, hdb, rec, 2);</font><br></td></tr>
	<tr><th>5044:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;dbf_read_field(tmp3, hdb, rec, 3);</font><br></td></tr>
	<tr><th>5045:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_27"><th>5046:</th><td><a href="#SliceElement_26">Prev</a> - <a href="#SliceElement_28">Next</a></td>
																						   <td><b><font color='red'> &nbsp; &nbsp;if (value = tmp1) then</font></b><br></td></tr>
	<tr><th>5047:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;begin</font><br></td></tr>
	<tr><th>5048:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;if (tmp3 &lt;&gt; '') then farchiveflag := strtoint(tmp3) else farchiveflag := -1;</font><br></td></tr>
	<tr><th>5049:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5050:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;dbf_read_field(tmp1, hdb, rec, 4);</font><br></td></tr>
	<tr><th>5051:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_28"><th>5052:</th><td><a href="#SliceElement_27">Prev</a> - <a href="#SliceElement_29">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp; &nbsp;d := stoi(tmp1, 3, 0);</font></b><br></td></tr>
	<tr><th>5053:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;if (d = maxint) then</font><br></td></tr>
	<tr><th>5054:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;farchivedate := '800101'</font><br></td></tr>
	<tr><th>5055:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;else</font><br></td></tr>
	<tr><th>5056:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;farchivedate := copy(inttostr(d), 2, 6);</font><br></td></tr>
	<tr><th>5057:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5058:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;dbf_read_field(farchivetx, hdb, rec, 5);</font><br></td></tr>
	<tr><th>5059:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;dbf_read_field(farchivedisk, hdb, rec, 6);</font><br></td></tr>
	<tr><th>5060:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5061:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;dbf_close(hdb);</font><br></td></tr>
	<tr><th>5062:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>5063:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>5064:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_29"><th>5065:</th><td><a href="#SliceElement_28">Prev</a> - <a href="#SliceElement_30">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;rec &nbsp;:= stoi(tmp2, 3, 0);</font></b><br></td></tr>
	<tr><th>5066:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;inc(cnt);</font><br></td></tr>
	<tr><th>5067:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr><th>5068:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5069:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// if nothing is found after maxlinks links we probably have a corrupt history db</font><br></td></tr>
	<tr><th>5070:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;if (cnt = maxlinks) then ferrors.add('infinite loop in history db. rehashing will solve this.', 0, 0, false, true);</font><br></td></tr>
	<tr><th>5071:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5072:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;dbf_close(hdb);</font><br></td></tr>
	<tr><th>5073:</th><td>&nbsp;</td><td><font size="3" color="grey">end;</font><br></td></tr>
	<tr><th>&nbsp;</th><td>&nbsp;</td><td><font size="3" color="grey">&nbsp;<hr></font><br></td></tr>
	<tr id="SliceElement_30"><th>6239:</th><td><a href="#SliceElement_29">Prev</a> - <a href="#SliceElement_31">Next</a></td>
																						   <td><b><font color='red'>function tquirtpatient.addpatient(patid, patname, patgender, planname: string;</font></b><br></td></tr>
	<tr id="SliceElement_31"><th>6240:</th><td><a href="#SliceElement_30">Prev</a> - <a href="#SliceElement_32">Next</a></td>
																						   <td><b><font color='red'> &nbsp; &nbsp; &nbsp; &nbsp; patage, patlength, patweight, patgirth: integer; patbdate, pataddr,</font></b><br></td></tr>
	<tr id="SliceElement_32"><th>6241:</th><td><a href="#SliceElement_31">Prev</a> - <a href="#SliceElement_33">Next</a></td>
																						   <td><b><font color='red'> &nbsp; &nbsp; &nbsp; &nbsp; patcity, patphone: string; daystoautoarchive: integer): boolean;</font></b><br></td></tr>
	<tr><th>6242:</th><td>&nbsp;</td><td><font size="3" color="grey">var</font><br></td></tr>
	<tr><th>6243:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;historyrec: int64;</font><br></td></tr>
	<tr><th>6244:</th><td>&nbsp;</td><td><font size="3" color="grey">begin</font><br></td></tr>
	<tr><th>6245:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// let's assume that everything will go well</font><br></td></tr>
	<tr><th>6246:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;result := true;</font><br></td></tr>
	<tr><th>6247:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6248:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// before we proceed, test to see if a patient with patientid really does</font><br></td></tr>
	<tr><th>6249:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// not yet exist. turn of most of the autoloading, as we won't need it here</font><br></td></tr>
	<tr><th>6250:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;autoloadoptions := [alpatientname];</font><br></td></tr>
	<tr><th>6251:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;patientid := patid;</font><br></td></tr>
	<tr><th>6252:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6253:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// exit (with result := false) when patient patid appears to exist after all</font><br></td></tr>
	<tr><th>6254:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;if(patientid &lt;&gt; '') then begin</font><br></td></tr>
	<tr><th>6255:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;ferrors.add('cannot create patient with patientid ' + patid + ': already exists!', 0, 0, false, true);</font><br></td></tr>
	<tr><th>6256:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6257:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>6258:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr><th>6259:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6260:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;getpatienthistory(patid, historyrec, historyrec);</font><br></td></tr>
	<tr><th>6261:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6262:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// in case of a non-existing patient (historyrec = 0) or of a deleted</font><br></td></tr>
	<tr><th>6263:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// patient (farchiveflag = 2), we should add the patient to the databases.</font><br></td></tr>
	<tr><th>6264:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;//</font><br></td></tr>
	<tr><th>6265:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// when the patient is deleted, adding to history.dbf is not necessary, but</font><br></td></tr>
	<tr><th>6266:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// his flag should be reset to 1.</font><br></td></tr>
	<tr id="SliceElement_33"><th>6267:</th><td><a href="#SliceElement_32">Prev</a> - <a href="#SliceElement_34">Next</a></td>
																						   <td><b><font color='red'> &nbsp;if((historyrec = 0) or (farchiveflag = 2)) then begin</font></b><br></td></tr>
	<tr><th>6268:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;try</font><br></td></tr>
	<tr><th>6269:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;if(not directoryexists(fmaindir + 'images\' + patid)) then begin</font><br></td></tr>
	<tr><th>6270:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;if(not createdir(fmaindir + 'images\' + patid)) then begin</font><br></td></tr>
	<tr><th>6271:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ferrors.add('could not create patient directory for patient ' + patid, 0, 0, false, true);</font><br></td></tr>
	<tr><th>6272:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6273:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>6274:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6275:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6276:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;except</font><br></td></tr>
	<tr><th>6277:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;ferrors.add('an exception occured while creating patient directory for patient ' + patid, 0, 0, false, true);</font><br></td></tr>
	<tr><th>6278:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6279:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>6280:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6281:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6282:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;// depending upon whether this patient is deleted or not, either undelete</font><br></td></tr>
	<tr><th>6283:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;// the patient, or add him to the history database.</font><br></td></tr>
	<tr id="SliceElement_34"><th>6284:</th><td><a href="#SliceElement_33">Prev</a> - <a href="#SliceElement_35">Next</a></td>
																						   <td><b><font color='red'> &nbsp; &nbsp;if(farchiveflag = 2) then begin</font></b><br></td></tr>
	<tr id="SliceElement_35"><th>6285:</th><td><a href="#SliceElement_34">Prev</a> - <a href="#SliceElement_36">Next</a></td>
																						   <td><b><font color='red'> &nbsp; &nbsp; &nbsp;if(not undeletepatient(patid)) then begin</font></b><br></td></tr>
	<tr><th>6286:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;ferrors.add('could not undelete patient with patientid=' + patid, 0, 0, false, true);</font><br></td></tr>
	<tr><th>6287:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6288:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>6289:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6290:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end else if(not addtohistorydb(patid, planname)) then begin</font><br></td></tr>
	<tr><th>6291:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;ferrors.add('could not add patient to the history database', 0, 0, false, true);</font><br></td></tr>
	<tr><th>6292:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6293:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>6294:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6295:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6296:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;{ try to add the patient to the mtech (patmtech.dbf) database }</font><br></td></tr>
	<tr><th>6297:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;if(not addtopatmtechdb(patid, planname, patgender, patage, patlength, patweight, patgirth, daystoautoarchive)) then begin</font><br></td></tr>
	<tr><th>6298:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;ferrors.add('could not add patient to the patmtech database', 0, 0, false, true);</font><br></td></tr>
	<tr><th>6299:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6300:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>6301:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6302:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6303:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;{ try to add the patient to the personal (secure\patpers.dbf) database }</font><br></td></tr>
	<tr><th>6304:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;if(not addtopersonaldb(patid, planname, patname, patbdate, pataddr, patcity, patphone)) then begin</font><br></td></tr>
	<tr><th>6305:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;ferrors.add('could not add patient to the personal database', 0, 0, false, true);</font><br></td></tr>
	<tr><th>6306:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6307:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>6308:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6309:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end else begin</font><br></td></tr>
	<tr><th>6310:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;ferrors.add('illegal attempt to add patient. patient "' + patid + '" already has entries in the history database', 0, 0, false, true);</font><br></td></tr>
	<tr><th>6311:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6312:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>6313:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr><th>6314:</th><td>&nbsp;</td><td><font size="3" color="grey">end;</font><br></td></tr>
	<tr><th>&nbsp;</th><td>&nbsp;</td><td><font size="3" color="grey">&nbsp;<hr></font><br></td></tr>
	<tr id="SliceElement_36"><th>6322:</th><td><a href="#SliceElement_35">Prev</a> - <a href="#SliceElement_37">Next</a></td>
																						   <td><b><font color='red'>function tquirtpatient.undeletepatient(patientid: string): boolean;</font></b><br></td></tr>
	<tr><th>6323:</th><td>&nbsp;</td><td><font size="3" color="grey">var</font><br></td></tr>
	<tr><th>6324:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;dbhandle: integer;</font><br></td></tr>
	<tr><th>6325:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;historyrec: int64;</font><br></td></tr>
	<tr><th>6326:</th><td>&nbsp;</td><td><font size="3" color="grey">begin</font><br></td></tr>
	<tr><th>6327:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;result := true;</font><br></td></tr>
	<tr><th>6328:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6329:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// obtain this patient's record in the history.dbf database</font><br></td></tr>
	<tr id="SliceElement_37"><th>6330:</th><td><a href="#SliceElement_36">Prev</a> - <a href="#SliceElement_38">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;getpatienthistory(patientid, historyrec, historyrec);</font></b><br></td></tr>
	<tr><th>6331:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6332:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// only if this patient has a record in the history.dbf database, continue</font><br></td></tr>
	<tr id="SliceElement_38"><th>6333:</th><td><a href="#SliceElement_37">Prev</a> - <a href="#SliceElement_39">Next</a></td>
																						   <td><b><font color='red'> &nbsp;if(historyrec &lt;&gt; 0) then begin</font></b><br></td></tr>
	<tr><th>6334:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;try</font><br></td></tr>
	<tr><th>6335:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;dbf_open(dbhandle, fqe.historydbname, true);</font><br></td></tr>
	<tr><th>6336:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;except</font><br></td></tr>
	<tr><th>6337:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;ferrors.add('could not open database ' + fqe.historydbname);</font><br></td></tr>
	<tr><th>6338:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6339:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>6340:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6341:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_39"><th>6342:</th><td><a href="#SliceElement_38">Prev</a> - <a href="#SliceElement_40">Next</a></td>
																						   <td><b><font color='red'> &nbsp; &nbsp;try</font></b><br></td></tr>
	<tr id="SliceElement_40"><th>6343:</th><td><a href="#SliceElement_39">Prev</a> - <a href="#SliceElement_41">Next</a></td>
																						   <td><b><font color='red'> &nbsp; &nbsp; &nbsp;try</font></b><br></td></tr>
	<tr><th>6344:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;// lock record</font><br></td></tr>
	<tr><th>6345:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;dbf_lock(dbhandle, historyrec, 1, true);</font><br></td></tr>
	<tr><th>6346:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6347:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;// write '1' to the 'flag' field of this patient's record in history.dbf</font><br></td></tr>
	<tr id="SliceElement_41"><th>6348:</th><td><a href="#SliceElement_40">Prev</a> - <a href="#SliceElement_42">Next</a></td>
																						   <td><b><font color='green'> &nbsp; &nbsp; &nbsp; &nbsp;dbf_write_field('1', dbhandle, historyrec, 3);</font></b><br></td></tr>
	<tr><th>6349:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6350:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;// unlock record</font><br></td></tr>
	<tr><th>6351:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;dbf_lock(dbhandle, historyrec, 1, false);</font><br></td></tr>
	<tr><th>6352:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;except</font><br></td></tr>
	<tr><th>6353:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;ferrors.add('an error occured while resetting this patient''s flag', 0, 0, false);</font><br></td></tr>
	<tr><th>6354:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6355:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6356:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;finally</font><br></td></tr>
	<tr><th>6357:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;dbf_close(dbhandle);</font><br></td></tr>
	<tr><th>6358:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6359:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr><th>6360:</th><td>&nbsp;</td><td><font size="3" color="grey">end;</font><br></td></tr>
</table></html>
