<html>

							<head>

								<title>Delphi Code Slice: start line: 6405 vars: ["tempval2","tempval1","dbhandle","0","9"] </title>

							</head>

							<body>

							<p><b>Delphi Code Slice: start line: 6405 vars: ["tempval2","tempval1","dbhandle","0","9"]</b><br></p>
							<table width="100%">

							<tr id="SliceElement_0"><th>&nbsp;</th><th ><a href="#SliceElement_1">Next</a></th><th>&nbsp;</th></tr>
	<tr><th>&nbsp;</th><td>&nbsp;</td><td><font size="3" color="grey">&nbsp;<hr></font><br></td></tr>
	<tr id="SliceElement_1"><th>1202:</th><td><a href="#SliceElement_0">Prev</a> - <a href="#SliceElement_2">Next</a></td>
																						   <td><b><font color='orange'>function stoi(p : string; len, offs : integer) : integer;</font></b><br></td></tr>
	<tr><th>1203:</th><td>&nbsp;</td><td><font size="3" color="grey">var</font><br></td></tr>
	<tr><th>1204:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;i : integer;</font><br></td></tr>
	<tr><th>1205:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;answer, compare : integer;</font><br></td></tr>
	<tr><th>1206:</th><td>&nbsp;</td><td><font size="3" color="grey">begin</font><br></td></tr>
	<tr id="SliceElement_2"><th>1207:</th><td><a href="#SliceElement_1">Prev</a> - <a href="#SliceElement_3">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;if (len &gt; 5) then len := 5;</font></b><br></td></tr>
	<tr id="SliceElement_3"><th>1208:</th><td><a href="#SliceElement_2">Prev</a> - <a href="#SliceElement_4">Next</a></td>
																						   <td><b><font color='red'> &nbsp;if ((offs + len) &gt; length(p)) then</font></b><br></td></tr>
	<tr><th>1209:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;begin</font><br></td></tr>
	<tr id="SliceElement_4"><th>1210:</th><td><a href="#SliceElement_3">Prev</a> - <a href="#SliceElement_5">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;result := maxint;</font></b><br></td></tr>
	<tr><th>1211:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>1212:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr><th>1213:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_5"><th>1214:</th><td><a href="#SliceElement_4">Prev</a> - <a href="#SliceElement_6">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;answer &nbsp;:= 0;</font></b><br></td></tr>
	<tr id="SliceElement_6"><th>1215:</th><td><a href="#SliceElement_5">Prev</a> - <a href="#SliceElement_7">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;compare := 0;</font></b><br></td></tr>
	<tr><th>1216:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_7"><th>1217:</th><td><a href="#SliceElement_6">Prev</a> - <a href="#SliceElement_8">Next</a></td>
																						   <td><b><font color='red'> &nbsp;for i := 1 to len do</font></b><br></td></tr>
	<tr><th>1218:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;begin</font><br></td></tr>
	<tr id="SliceElement_8"><th>1219:</th><td><a href="#SliceElement_7">Prev</a> - <a href="#SliceElement_9">Next</a></td>
																						   <td><b><font color='red'> &nbsp; &nbsp;if (p[i+offs] &lt; '0') then</font></b><br></td></tr>
	<tr><th>1220:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;begin</font><br></td></tr>
	<tr id="SliceElement_9"><th>1221:</th><td><a href="#SliceElement_8">Prev</a> - <a href="#SliceElement_10">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp; &nbsp;result := maxint;</font></b><br></td></tr>
	<tr><th>1222:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>1223:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end;</font><br></td></tr>
	<tr id="SliceElement_10"><th>1224:</th><td><a href="#SliceElement_9">Prev</a> - <a href="#SliceElement_11">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;answer &nbsp;:= answer * 208 + ord(p[i+offs]) - ord('0');</font></b><br></td></tr>
	<tr id="SliceElement_11"><th>1225:</th><td><a href="#SliceElement_10">Prev</a> - <a href="#SliceElement_12">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;compare := compare * 208;</font></b><br></td></tr>
	<tr><th>1226:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr><th>1227:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_12"><th>1228:</th><td><a href="#SliceElement_11">Prev</a> - <a href="#SliceElement_13">Next</a></td>
																						   <td><b><font color='red'> &nbsp;if ( (answer &lt; compare div 2) or (len=5) ) then</font></b><br></td></tr>
	<tr id="SliceElement_13"><th>1229:</th><td><a href="#SliceElement_12">Prev</a> - <a href="#SliceElement_14">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;result := answer</font></b><br></td></tr>
	<tr><th>1230:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;else</font><br></td></tr>
	<tr id="SliceElement_14"><th>1231:</th><td><a href="#SliceElement_13">Prev</a> - <a href="#SliceElement_15">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;result := answer - compare;</font></b><br></td></tr>
	<tr><th>1232:</th><td>&nbsp;</td><td><font size="3" color="grey">end;</font><br></td></tr>
	<tr><th>&nbsp;</th><td>&nbsp;</td><td><font size="3" color="grey">&nbsp;<hr></font><br></td></tr>
	<tr id="SliceElement_15"><th>1236:</th><td><a href="#SliceElement_14">Prev</a> - <a href="#SliceElement_16">Next</a></td>
																						   <td><b><font color='orange'>function itos(len, value : integer) : ansistring;</font></b><br></td></tr>
	<tr><th>1237:</th><td>&nbsp;</td><td><font size="3" color="grey">var</font><br></td></tr>
	<tr><th>1238:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;i : integer;</font><br></td></tr>
	<tr><th>1239:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;maxval : integer;</font><br></td></tr>
	<tr><th>1240:</th><td>&nbsp;</td><td><font size="3" color="grey">begin</font><br></td></tr>
	<tr><th>1241:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// invalid is '*' with len length</font><br></td></tr>
	<tr id="SliceElement_16"><th>1242:</th><td><a href="#SliceElement_15">Prev</a> - <a href="#SliceElement_17">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;result := '';</font></b><br></td></tr>
	<tr id="SliceElement_17"><th>1243:</th><td><a href="#SliceElement_16">Prev</a> - <a href="#SliceElement_18">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;for i := 1 to min(len, 5) do result := result +'*';</font></b><br></td></tr>
	<tr><th>1244:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_18"><th>1245:</th><td><a href="#SliceElement_17">Prev</a> - <a href="#SliceElement_19">Next</a></td>
																						   <td><b><font color='red'> &nbsp;if (len &gt;= 5) then</font></b><br></td></tr>
	<tr><th>1246:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;begin</font><br></td></tr>
	<tr id="SliceElement_19"><th>1247:</th><td><a href="#SliceElement_18">Prev</a> - <a href="#SliceElement_20">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;len &nbsp; &nbsp;:= 5;</font></b><br></td></tr>
	<tr id="SliceElement_20"><th>1248:</th><td><a href="#SliceElement_19">Prev</a> - <a href="#SliceElement_21">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;maxval := 0;</font></b><br></td></tr>
	<tr><th>1249:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end</font><br></td></tr>
	<tr><th>1250:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;else</font><br></td></tr>
	<tr><th>1251:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;begin</font><br></td></tr>
	<tr id="SliceElement_21"><th>1252:</th><td><a href="#SliceElement_20">Prev</a> - <a href="#SliceElement_22">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;maxval := 1;</font></b><br></td></tr>
	<tr id="SliceElement_22"><th>1253:</th><td><a href="#SliceElement_21">Prev</a> - <a href="#SliceElement_23">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;for i := 1 to len do maxval := maxval * 208;</font></b><br></td></tr>
	<tr><th>1254:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>1255:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;if (value &lt; -maxval/2) or (value &gt;= maxval/2) then</font><br></td></tr>
	<tr><th>1256:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;begin</font><br></td></tr>
	<tr><th>1257:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>1258:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>1259:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr><th>1260:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>1261:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;if (value = maxint) then</font><br></td></tr>
	<tr><th>1262:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;begin &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ invalid is set to maxint }</font><br></td></tr>
	<tr><th>1263:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>1264:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr><th>1265:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_23"><th>1266:</th><td><a href="#SliceElement_22">Prev</a> - <a href="#SliceElement_24">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;if (value &lt; 0) then value := value + maxval;</font></b><br></td></tr>
	<tr><th>1267:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>1268:</th><td>&nbsp;</td><td><font size="3" color="grey">// for (i=len-1; i&gt;=0; i--)</font><br></td></tr>
	<tr id="SliceElement_24"><th>1269:</th><td><a href="#SliceElement_23">Prev</a> - <a href="#SliceElement_25">Next</a></td>
																						   <td><b><font color='red'> &nbsp;for i := len downto 1 do</font></b><br></td></tr>
	<tr><th>1270:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;begin</font><br></td></tr>
	<tr id="SliceElement_25"><th>1271:</th><td><a href="#SliceElement_24">Prev</a> - <a href="#SliceElement_26">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;result[i] &nbsp;:= ansichar(chr( (value mod 208) + ord('0') ));</font></b><br></td></tr>
	<tr id="SliceElement_26"><th>1272:</th><td><a href="#SliceElement_25">Prev</a> - <a href="#SliceElement_27">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;value := value div 208;</font></b><br></td></tr>
	<tr><th>1273:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr><th>1274:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>1275:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;setlength(result, len);</font><br></td></tr>
	<tr><th>1276:</th><td>&nbsp;</td><td><font size="3" color="grey">end;</font><br></td></tr>
	<tr><th>&nbsp;</th><td>&nbsp;</td><td><font size="3" color="grey">&nbsp;<hr></font><br></td></tr>
	<tr id="SliceElement_27"><th>4995:</th><td><a href="#SliceElement_26">Prev</a> - <a href="#SliceElement_28">Next</a></td>
																						   <td><b><font color='orange'>procedure tquirtpatient.getpatienthistory (value : string; var rec, prec: int64);</font></b><br></td></tr>
	<tr><th>4996:</th><td>&nbsp;</td><td><font size="3" color="grey">const</font><br></td></tr>
	<tr><th>4997:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;maxlinks &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 2000;</font><br></td></tr>
	<tr><th>4998:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>4999:</th><td>&nbsp;</td><td><font size="3" color="grey">var</font><br></td></tr>
	<tr><th>5000:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;i, hdb, hcount, cnt, d &nbsp; &nbsp; : integer;</font><br></td></tr>
	<tr><th>5001:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;tmp1, tmp2, tmp3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : string;</font><br></td></tr>
	<tr><th>5002:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5003:</th><td>&nbsp;</td><td><font size="3" color="grey">begin</font><br></td></tr>
	<tr><th>5004:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;prec &nbsp; &nbsp; &nbsp; &nbsp; := -1;</font><br></td></tr>
	<tr><th>5005:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;farchiveflag := -1;</font><br></td></tr>
	<tr><th>5006:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5007:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;{ test existence database }</font><br></td></tr>
	<tr><th>5008:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;if not fileexists(fqe.fhistorydbname) then exit;</font><br></td></tr>
	<tr><th>5009:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5010:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;{ compute the hash function on the patient id }</font><br></td></tr>
	<tr><th>5011:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_28"><th>5012:</th><td><a href="#SliceElement_27">Prev</a> - <a href="#SliceElement_29">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;rec &nbsp; := 0;</font></b><br></td></tr>
	<tr id="SliceElement_29"><th>5013:</th><td><a href="#SliceElement_28">Prev</a> - <a href="#SliceElement_30">Next</a></td>
																						   <td><b><font color='red'> &nbsp;for i := 1 to length(value) do</font></b><br></td></tr>
	<tr><th>5014:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;begin</font><br></td></tr>
	<tr id="SliceElement_30"><th>5015:</th><td><a href="#SliceElement_29">Prev</a> - <a href="#SliceElement_31">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;rec := rec * 10;</font></b><br></td></tr>
	<tr id="SliceElement_31"><th>5016:</th><td><a href="#SliceElement_30">Prev</a> - <a href="#SliceElement_32">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;rec := rec + ord(value[i]);</font></b><br></td></tr>
	<tr><th>5017:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr id="SliceElement_32"><th>5018:</th><td><a href="#SliceElement_31">Prev</a> - <a href="#SliceElement_33">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;rec := abs(rec);</font></b><br></td></tr>
	<tr><th>5019:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5020:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;{ read the number of hash values from record 0 in the database }</font><br></td></tr>
	<tr><th>5021:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5022:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;dbf_open(hdb, fqe.fhistorydbname, true);</font><br></td></tr>
	<tr><th>5023:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;dbf_read_field(tmp2, hdb, 0, 2);</font><br></td></tr>
	<tr id="SliceElement_33"><th>5024:</th><td><a href="#SliceElement_32">Prev</a> - <a href="#SliceElement_34">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;hcount := stoi(tmp2, 3, 0);</font></b><br></td></tr>
	<tr id="SliceElement_34"><th>5025:</th><td><a href="#SliceElement_33">Prev</a> - <a href="#SliceElement_35">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;rec &nbsp; &nbsp;:= (rec mod hcount) + 1;</font></b><br></td></tr>
	<tr><th>5026:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_35"><th>5027:</th><td><a href="#SliceElement_34">Prev</a> - <a href="#SliceElement_36">Next</a></td>
																						   <td><b><font color='red'> &nbsp;if (hcount = maxint) then</font></b><br></td></tr>
	<tr><th>5028:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;begin</font><br></td></tr>
	<tr id="SliceElement_36"><th>5029:</th><td><a href="#SliceElement_35">Prev</a> - <a href="#SliceElement_37">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;rec := -1;</font></b><br></td></tr>
	<tr><th>5030:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;ferrors.add('error reading hash count from history database.', 0, 0, false, true);</font><br></td></tr>
	<tr><th>5031:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;dbf_close(hdb);</font><br></td></tr>
	<tr><th>5032:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>5033:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr><th>5034:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5035:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;{ search the linked list }</font><br></td></tr>
	<tr><th>5036:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_37"><th>5037:</th><td><a href="#SliceElement_36">Prev</a> - <a href="#SliceElement_38">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;cnt := 0;</font></b><br></td></tr>
	<tr><th>5038:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_38"><th>5039:</th><td><a href="#SliceElement_37">Prev</a> - <a href="#SliceElement_39">Next</a></td>
																						   <td><b><font color='red'> &nbsp;while (rec &lt;&gt; 0) and (cnt &lt; maxlinks) do</font></b><br></td></tr>
	<tr><th>5040:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;begin</font><br></td></tr>
	<tr><th>5041:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;prec := rec;</font><br></td></tr>
	<tr><th>5042:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;dbf_read_field(tmp1, hdb, rec, 1);</font><br></td></tr>
	<tr><th>5043:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;dbf_read_field(tmp2, hdb, rec, 2);</font><br></td></tr>
	<tr><th>5044:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;dbf_read_field(tmp3, hdb, rec, 3);</font><br></td></tr>
	<tr><th>5045:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_39"><th>5046:</th><td><a href="#SliceElement_38">Prev</a> - <a href="#SliceElement_40">Next</a></td>
																						   <td><b><font color='red'> &nbsp; &nbsp;if (value = tmp1) then</font></b><br></td></tr>
	<tr><th>5047:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;begin</font><br></td></tr>
	<tr><th>5048:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;if (tmp3 &lt;&gt; '') then farchiveflag := strtoint(tmp3) else farchiveflag := -1;</font><br></td></tr>
	<tr><th>5049:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5050:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;dbf_read_field(tmp1, hdb, rec, 4);</font><br></td></tr>
	<tr><th>5051:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_40"><th>5052:</th><td><a href="#SliceElement_39">Prev</a> - <a href="#SliceElement_41">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp; &nbsp;d := stoi(tmp1, 3, 0);</font></b><br></td></tr>
	<tr><th>5053:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;if (d = maxint) then</font><br></td></tr>
	<tr><th>5054:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;farchivedate := '800101'</font><br></td></tr>
	<tr><th>5055:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;else</font><br></td></tr>
	<tr><th>5056:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;farchivedate := copy(inttostr(d), 2, 6);</font><br></td></tr>
	<tr><th>5057:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5058:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;dbf_read_field(farchivetx, hdb, rec, 5);</font><br></td></tr>
	<tr><th>5059:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;dbf_read_field(farchivedisk, hdb, rec, 6);</font><br></td></tr>
	<tr><th>5060:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5061:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;dbf_close(hdb);</font><br></td></tr>
	<tr><th>5062:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>5063:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>5064:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_41"><th>5065:</th><td><a href="#SliceElement_40">Prev</a> - <a href="#SliceElement_42">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp;rec &nbsp;:= stoi(tmp2, 3, 0);</font></b><br></td></tr>
	<tr><th>5066:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;inc(cnt);</font><br></td></tr>
	<tr><th>5067:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr><th>5068:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5069:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// if nothing is found after maxlinks links we probably have a corrupt history db</font><br></td></tr>
	<tr><th>5070:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;if (cnt = maxlinks) then ferrors.add('infinite loop in history db. rehashing will solve this.', 0, 0, false, true);</font><br></td></tr>
	<tr><th>5071:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>5072:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;dbf_close(hdb);</font><br></td></tr>
	<tr><th>5073:</th><td>&nbsp;</td><td><font size="3" color="grey">end;</font><br></td></tr>
	<tr><th>&nbsp;</th><td>&nbsp;</td><td><font size="3" color="grey">&nbsp;<hr></font><br></td></tr>
	<tr id="SliceElement_42"><th>6239:</th><td><a href="#SliceElement_41">Prev</a> - <a href="#SliceElement_43">Next</a></td>
																						   <td><b><font color='red'>function tquirtpatient.addpatient(patid, patname, patgender, planname: string;</font></b><br></td></tr>
	<tr id="SliceElement_43"><th>6240:</th><td><a href="#SliceElement_42">Prev</a> - <a href="#SliceElement_44">Next</a></td>
																						   <td><b><font color='red'> &nbsp; &nbsp; &nbsp; &nbsp; patage, patlength, patweight, patgirth: integer; patbdate, pataddr,</font></b><br></td></tr>
	<tr id="SliceElement_44"><th>6241:</th><td><a href="#SliceElement_43">Prev</a> - <a href="#SliceElement_45">Next</a></td>
																						   <td><b><font color='red'> &nbsp; &nbsp; &nbsp; &nbsp; patcity, patphone: string; daystoautoarchive: integer): boolean;</font></b><br></td></tr>
	<tr><th>6242:</th><td>&nbsp;</td><td><font size="3" color="grey">var</font><br></td></tr>
	<tr><th>6243:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;historyrec: int64;</font><br></td></tr>
	<tr><th>6244:</th><td>&nbsp;</td><td><font size="3" color="grey">begin</font><br></td></tr>
	<tr><th>6245:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// let's assume that everything will go well</font><br></td></tr>
	<tr><th>6246:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;result := true;</font><br></td></tr>
	<tr><th>6247:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6248:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// before we proceed, test to see if a patient with patientid really does</font><br></td></tr>
	<tr><th>6249:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// not yet exist. turn of most of the autoloading, as we won't need it here</font><br></td></tr>
	<tr><th>6250:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;autoloadoptions := [alpatientname];</font><br></td></tr>
	<tr><th>6251:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;patientid := patid;</font><br></td></tr>
	<tr><th>6252:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6253:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// exit (with result := false) when patient patid appears to exist after all</font><br></td></tr>
	<tr><th>6254:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;if(patientid &lt;&gt; '') then begin</font><br></td></tr>
	<tr><th>6255:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;ferrors.add('cannot create patient with patientid ' + patid + ': already exists!', 0, 0, false, true);</font><br></td></tr>
	<tr><th>6256:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6257:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>6258:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr><th>6259:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6260:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;getpatienthistory(patid, historyrec, historyrec);</font><br></td></tr>
	<tr><th>6261:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6262:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// in case of a non-existing patient (historyrec = 0) or of a deleted</font><br></td></tr>
	<tr><th>6263:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// patient (farchiveflag = 2), we should add the patient to the databases.</font><br></td></tr>
	<tr><th>6264:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;//</font><br></td></tr>
	<tr><th>6265:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// when the patient is deleted, adding to history.dbf is not necessary, but</font><br></td></tr>
	<tr><th>6266:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;// his flag should be reset to 1.</font><br></td></tr>
	<tr id="SliceElement_45"><th>6267:</th><td><a href="#SliceElement_44">Prev</a> - <a href="#SliceElement_46">Next</a></td>
																						   <td><b><font color='red'> &nbsp;if((historyrec = 0) or (farchiveflag = 2)) then begin</font></b><br></td></tr>
	<tr><th>6268:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;try</font><br></td></tr>
	<tr><th>6269:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;if(not directoryexists(fmaindir + 'images\' + patid)) then begin</font><br></td></tr>
	<tr><th>6270:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;if(not createdir(fmaindir + 'images\' + patid)) then begin</font><br></td></tr>
	<tr><th>6271:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ferrors.add('could not create patient directory for patient ' + patid, 0, 0, false, true);</font><br></td></tr>
	<tr><th>6272:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6273:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>6274:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6275:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6276:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;except</font><br></td></tr>
	<tr><th>6277:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;ferrors.add('an exception occured while creating patient directory for patient ' + patid, 0, 0, false, true);</font><br></td></tr>
	<tr><th>6278:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6279:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>6280:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6281:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6282:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;// depending upon whether this patient is deleted or not, either undelete</font><br></td></tr>
	<tr><th>6283:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;// the patient, or add him to the history database.</font><br></td></tr>
	<tr id="SliceElement_46"><th>6284:</th><td><a href="#SliceElement_45">Prev</a> - <a href="#SliceElement_47">Next</a></td>
																						   <td><b><font color='red'> &nbsp; &nbsp;if(farchiveflag = 2) then begin</font></b><br></td></tr>
	<tr><th>6285:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;if(not undeletepatient(patid)) then begin</font><br></td></tr>
	<tr><th>6286:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;ferrors.add('could not undelete patient with patientid=' + patid, 0, 0, false, true);</font><br></td></tr>
	<tr><th>6287:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6288:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>6289:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;end;</font><br></td></tr>
	<tr id="SliceElement_47"><th>6290:</th><td><a href="#SliceElement_46">Prev</a> - <a href="#SliceElement_48">Next</a></td>
																						   <td><b><font color='red'> &nbsp; &nbsp;end else if(not addtohistorydb(patid, planname)) then begin</font></b><br></td></tr>
	<tr><th>6291:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;ferrors.add('could not add patient to the history database', 0, 0, false, true);</font><br></td></tr>
	<tr><th>6292:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6293:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>6294:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6295:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6296:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;{ try to add the patient to the mtech (patmtech.dbf) database }</font><br></td></tr>
	<tr><th>6297:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;if(not addtopatmtechdb(patid, planname, patgender, patage, patlength, patweight, patgirth, daystoautoarchive)) then begin</font><br></td></tr>
	<tr><th>6298:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;ferrors.add('could not add patient to the patmtech database', 0, 0, false, true);</font><br></td></tr>
	<tr><th>6299:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6300:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>6301:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6302:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6303:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;{ try to add the patient to the personal (secure\patpers.dbf) database }</font><br></td></tr>
	<tr><th>6304:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;if(not addtopersonaldb(patid, planname, patname, patbdate, pataddr, patcity, patphone)) then begin</font><br></td></tr>
	<tr><th>6305:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;ferrors.add('could not add patient to the personal database', 0, 0, false, true);</font><br></td></tr>
	<tr><th>6306:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6307:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>6308:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6309:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end else begin</font><br></td></tr>
	<tr><th>6310:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;ferrors.add('illegal attempt to add patient. patient "' + patid + '" already has entries in the history database', 0, 0, false, true);</font><br></td></tr>
	<tr><th>6311:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6312:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;exit;</font><br></td></tr>
	<tr><th>6313:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr><th>6314:</th><td>&nbsp;</td><td><font size="3" color="grey">end;</font><br></td></tr>
	<tr><th>&nbsp;</th><td>&nbsp;</td><td><font size="3" color="grey">&nbsp;<hr></font><br></td></tr>
	<tr id="SliceElement_48"><th>6367:</th><td><a href="#SliceElement_47">Prev</a> - <a href="#SliceElement_49">Next</a></td>
																						   <td><b><font color='red'>function tquirtpatient.addtohistorydb(patid, treatment: string): boolean;</font></b><br></td></tr>
	<tr><th>6368:</th><td>&nbsp;</td><td><font size="3" color="grey">var</font><br></td></tr>
	<tr><th>6369:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;tempval, tempval1, tempval2: string;</font><br></td></tr>
	<tr><th>6370:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;i, j, recordcount, dbhandle: integer;</font><br></td></tr>
	<tr><th>6371:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;rec, prec: int64;</font><br></td></tr>
	<tr><th>6372:</th><td>&nbsp;</td><td><font size="3" color="grey">begin</font><br></td></tr>
	<tr><th>6373:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;result := true;</font><br></td></tr>
	<tr><th>6374:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6375:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;{ first, get the history of this patient }</font><br></td></tr>
	<tr id="SliceElement_49"><th>6376:</th><td><a href="#SliceElement_48">Prev</a> - <a href="#SliceElement_50">Next</a></td>
																						   <td><b><font color='orange'> &nbsp;getpatienthistory(patid, rec, prec);</font></b><br></td></tr>
	<tr><th>6377:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6378:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;{ if no less than 0 records were found, an error occurred, and we exit }</font><br></td></tr>
	<tr><th>6379:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;if(rec &lt; 0) then exit;</font><br></td></tr>
	<tr><th>6380:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6381:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;{ if no records were found, add the patient to the history database }</font><br></td></tr>
	<tr id="SliceElement_50"><th>6382:</th><td><a href="#SliceElement_49">Prev</a> - <a href="#SliceElement_51">Next</a></td>
																						   <td><b><font color='red'> &nbsp;if(rec = 0) then</font></b><br></td></tr>
	<tr><th>6383:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;begin</font><br></td></tr>
	<tr><th>6384:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;try</font><br></td></tr>
	<tr><th>6385:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;dbf_open(dbhandle, fqe.historydbname, true);</font><br></td></tr>
	<tr><th>6386:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;except</font><br></td></tr>
	<tr><th>6387:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;ferrors.add('could not open database ' + fqe.historydbname);</font><br></td></tr>
	<tr><th>6388:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6389:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6390:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6391:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;{ try - finally: make sure we always close the now open db}</font><br></td></tr>
	<tr id="SliceElement_51"><th>6392:</th><td><a href="#SliceElement_50">Prev</a> - <a href="#SliceElement_52">Next</a></td>
																						   <td><b><font color='red'> &nbsp; &nbsp;try</font></b><br></td></tr>
	<tr><th>6393:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;{ update the counters for total number of patient and valid number of patients }</font><br></td></tr>
	<tr><th>6394:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;{ in the 'accounting' record 0 }</font><br></td></tr>
	<tr id="SliceElement_52"><th>6395:</th><td><a href="#SliceElement_51">Prev</a> - <a href="#SliceElement_53">Next</a></td>
																						   <td><b><font color='red'> &nbsp; &nbsp; &nbsp;if(result) then begin</font></b><br></td></tr>
	<tr id="SliceElement_53"><th>6396:</th><td><a href="#SliceElement_52">Prev</a> - <a href="#SliceElement_54">Next</a></td>
																						   <td><b><font color='red'> &nbsp; &nbsp; &nbsp; &nbsp;try</font></b><br></td></tr>
	<tr><th>6397:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dbf_lock(dbhandle, 0, 1, true);</font><br></td></tr>
	<tr><th>6398:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dbf_read_field(tempval, dbhandle, 0, 9);</font><br></td></tr>
	<tr id="SliceElement_54"><th>6399:</th><td><a href="#SliceElement_53">Prev</a> - <a href="#SliceElement_55">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;i := stoi(tempval, 3, 0); // obtain the number of total patient id entries</font></b><br></td></tr>
	<tr id="SliceElement_55"><th>6400:</th><td><a href="#SliceElement_54">Prev</a> - <a href="#SliceElement_56">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;j := stoi(tempval, 3, 3); // obtain the number of true (valid) patient ids</font></b><br></td></tr>
	<tr><th>6401:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if(ord(patid[1]) &lt; ord('{')) then inc(j);</font><br></td></tr>
	<tr id="SliceElement_56"><th>6402:</th><td><a href="#SliceElement_55">Prev</a> - <a href="#SliceElement_57">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tempval1 := string(itos(3, i+1)); &nbsp; // create coded integer for total entries</font></b><br></td></tr>
	<tr id="SliceElement_57"><th>6403:</th><td><a href="#SliceElement_56">Prev</a> - <a href="#SliceElement_58">Next</a></td>
																						   <td><b><font color='orange'> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tempval2 := string(itos(3, j)); &nbsp; &nbsp; // create coded integer for valid patient id count</font></b><br></td></tr>
	<tr><th>6404:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr id="SliceElement_58"><th>6405:</th><td><a href="#SliceElement_57">Prev</a> - <a href="#SliceElement_59">Next</a></td>
																						   <td><b><font color='green'> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dbf_write_field(tempval1+tempval2, dbhandle, 0, 9);</font></b><br></td></tr>
	<tr><th>6406:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dbf_lock(dbhandle, 0, 1, false);</font><br></td></tr>
	<tr><th>6407:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;except</font><br></td></tr>
	<tr><th>6408:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ferrors.add('could not update patient counters in database ' + fqe.historydbname);</font><br></td></tr>
	<tr><th>6409:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6410:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6411:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6412:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6413:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;{ write record in empty place or append collisions to end of list }</font><br></td></tr>
	<tr><th>6414:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;if(result) then begin</font><br></td></tr>
	<tr><th>6415:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;try</font><br></td></tr>
	<tr><th>6416:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dbf_read_field(tempval, dbhandle, prec, 1);</font><br></td></tr>
	<tr><th>6417:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if(length(tempval) = 0) then begin</font><br></td></tr>
	<tr><th>6418:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dbf_write_field(qversion, dbhandle, prec, 0); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; { version }</font><br></td></tr>
	<tr><th>6419:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dbf_write_field(uppercase(patid), dbhandle, prec, 1); { patient id }</font><br></td></tr>
	<tr><th>6420:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dbf_write_field('000', dbhandle, prec, 2); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ next record }</font><br></td></tr>
	<tr><th>6421:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dbf_write_field('1', dbhandle, prec, 3); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ status flag. 1=online }</font><br></td></tr>
	<tr><th>6422:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dbf_write_field(treatment, dbhandle, prec, 5); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ plan name }</font><br></td></tr>
	<tr><th>6423:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rec := prec;</font><br></td></tr>
	<tr><th>6424:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;end else</font><br></td></tr>
	<tr><th>6425:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;begin</font><br></td></tr>
	<tr><th>6426:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ append the record to the end of the list.</font><br></td></tr>
	<tr><th>6427:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;after appending, retrieve the number of records in the database (-1).</font><br></td></tr>
	<tr><th>6428:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;this number is is inserted into the nextrec field of the prec'th record,</font><br></td></tr>
	<tr><th>6429:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;thus creating a linked list.</font><br></td></tr>
	<tr><th>6430:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6431:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lock the whole db for this action</font><br></td></tr>
	<tr><th>6432:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font><br></td></tr>
	<tr><th>6433:</th><td>&nbsp;</td><td><font size="3" color="grey"></font><br></td></tr>
	<tr><th>6434:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dbf_lock(dbhandle, -1, 1, true);</font><br></td></tr>
	<tr><th>6435:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dbappend(dbhandle, '"' + qversion + '", "' + uppercase(patid) +</font><br></td></tr>
	<tr><th>6436:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '", "000", "1", "", "' + treatment + '"');</font><br></td></tr>
	<tr><th>6437:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dbf_reccount(recordcount, dbhandle);</font><br></td></tr>
	<tr><th>6438:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tempval := string(itos(3, recordcount-1));</font><br></td></tr>
	<tr><th>6439:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dbf_write_field(tempval, dbhandle, prec, 2);</font><br></td></tr>
	<tr><th>6440:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dbf_lock(dbhandle, -1, 1, false);</font><br></td></tr>
	<tr><th>6441:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6442:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;except</font><br></td></tr>
	<tr><th>6443:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ferrors.add('could not update or add patient record to database ' + fqe.historydbname);</font><br></td></tr>
	<tr><th>6444:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;result := false;</font><br></td></tr>
	<tr><th>6445:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6446:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6447:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;finally</font><br></td></tr>
	<tr><th>6448:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp; &nbsp;dbf_close(dbhandle);</font><br></td></tr>
	<tr><th>6449:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp; &nbsp;end;</font><br></td></tr>
	<tr><th>6450:</th><td>&nbsp;</td><td><font size="3" color="grey"> &nbsp;end;</font><br></td></tr>
	<tr><th>6451:</th><td>&nbsp;</td><td><font size="3" color="grey">end;</font><br></td></tr>
</table></html>
